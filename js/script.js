// --- TRANSLATIONS ---
const translations = {
    fr: {
        desktop_computer: "Poste de Louka",
        desktop_projects: "Mes Projets",
        desktop_contact: "Contact",
        desktop_computer: "Poste de Louka",
        desktop_projects: "Mes Projets",
        desktop_contact: "Contact",
        desktop_minesweeper: "D√©mineur",
        desktop_skills: "Comp√©tences.exe",
        desktop_recycle: "Corbeille",
        desktop_dont_click: "NE PAS CLIQUER",
        desktop_ie: "Internet Explorer",
        desktop_terminal: "MS-DOS Prompt",
        desktop_winamp: "Winamp",
        desktop_paint: "Paint",
        desktop_cv: "Mon CV.pdf",
        win_minesweeper_title: "D√©mineur",
        win_paint_title: "Paint - Sans titre",
        ctx_refresh: "Actualiser",
        ctx_new: "Nouveau",
        ctx_properties: "Propri√©t√©s",
        start_notepad: "Bloc-notes",
        start_projects: "Mes Projets",
        start_skills: "Comp√©tences",
        start_cv: "Mon CV (FR)",
        start_cv_en: "Mon CV (EN)",
        start_about: "A propos",
        start_shutdown: "Arr√™ter...",
        win_about_title: "Poste de Louka - Propri√©t√©s",
        about_system: "Syst√®me :",
        about_system_val: "√âtudiant BUT Informatique",
        about_version: "Version :",
        about_location: "Localisation :",
        about_intro: "Bienvenue sur mon syst√®me ! Je suis un d√©veloppeur passionn√© par le Back-end, Java et l'automatisation.",
        about_goal: "Je cherche une alternance ou stage pour 2026.",
        notepad_file: "Fichier",
        notepad_edit: "Edition",
        notepad_search: "Recherche",
        notepad_help: "Aide",
        contact_intro: "Vous pouvez me contacter √† cette adresse :",
        contact_btn_copy: "Copier l'adresse",
        ie_welcome: "Bienvenue sur Internet",
        paint_help: "Pour aide, cliquez sur Aide dans le menu Aide.",
        shutdown_text: "VOUS POUVEZ MAINTENANT √âTEINDRE<br>VOTRE ORDINATEUR EN TOUTE S√âCURIT√â.",
        restart_hint: "(Cliquez pour red√©marrer)",
        win_properties_title: "Propri√©t√©s de Affichage",
        prop_wallpaper: "Papier peint",
        btn_apply: "Appliquer",
        btn_cancel: "Annuler",
        win_recycle_title: "Corbeille",
        win_calendar_title: "Calendrier",
        detail_desc: "Description:",
        detail_tech: "Technologies:",
        detail_skills: "Comp√©tences:",
        detail_btn_see: "Voir le Code / D√©mo",
        detail_btn_close: "Fermer",
        clippy_intro: "Salut ! Je vois que vous cherchez un d√©veloppeur comp√©tent. Besoin d'aide ?",
        clippy_dblclick: "Astuce : Double-cliquez sur les ic√¥nes pour les ouvrir.",
        clippy_cv: "Je vois que vous regardez mon CV. Excellent choix !",
        clippy_mine: "N'oubliez pas de tester le D√©mineur !",
        clippy_projects: "Besoin d'un site web ? Louka est l√† pour √ßa !",
        clippy_matrix: "Tapez 'matrix' dans le terminal pour un effet cool.",
        clippy_wallpaper: "Vous pouvez changer le fond d'√©cran avec un clic droit !",

        // NEW ENHANCEMENTS keys
        start_taskmgr: "Gestionnaire des t√¢ches",
        win_taskmgr_title: "Gestionnaire des t√¢ches",
        winamp_playing: "LECTURE ENC: SYNTHWAVE_MIX_2024.MP3",
        winamp_paused: "PAUSE",
        winamp_stopped: "STOP",

        // NOUVEAUX AJOUTS (Missing static text)
        boot_sequence: "D√©marrage de LoukaOS 98...",
        bsod_fatal: "Une exception fatale 0E est survenue √† 0028:C0011E36 dans VXD VMM(01) + 00010E36.",
        bsod_terminated: "L'application en cours va se terminer.",
        bsod_press_any: "* Appuyez sur une touche pour terminer l'application.",
        bsod_ctrl_alt: "* Appuyez sur CTRL+ALT+SUPPR pour red√©marrer.",
        bsod_continue: "Appuyez sur une touche pour continuer _",

        win_projects_explorer: "C:\\Mes Documents\\Projets",
        win_recycle_explorer: "C:\\Corbeille",

        file_abandoned: "Projet_abandonn√©_v1.doc",
        file_obsolete: "Donn√©es_obsol√®tes.xls",
        file_bug: "bug_infini.js",

        cal_mo: "Lu", cal_tu: "Ma", cal_we: "Me", cal_th: "Je", cal_fr: "Ve", cal_sa: "Sa", cal_su: "Di",

        winamp_marquee: "WINAMP 1.91 - MODE DEMO - AUCUN FICHIER AUDIO CHARG√â",

        ie_github: "GitHub",
        ie_linkedin: "LinkedIn",

        notepad_placeholder: "√âcrivez quelque chose...",

        tool_pencil: "Crayon",
        tool_eraser: "Gomme",
        tool_clear: "Tout effacer",

        month_0: "Janvier", month_1: "F√©vrier", month_2: "Mars", month_3: "Avril", month_4: "Mai", month_5: "Juin",
        month_6: "Juillet", month_7: "Ao√ªt", month_8: "Septembre", month_9: "Octobre", month_10: "Novembre", month_11: "D√©cembre"
    },
    en: {
        desktop_computer: "Louka's PC",
        desktop_projects: "My Projects",
        desktop_contact: "Contact",
        desktop_minesweeper: "Minesweeper",
        desktop_skills: "Skills.exe",
        desktop_recycle: "Recycle Bin",
        desktop_dont_click: "DO NOT CLICK",
        desktop_ie: "Internet Explorer",
        desktop_terminal: "MS-DOS Prompt",
        desktop_winamp: "Winamp",
        desktop_paint: "Paint",
        desktop_cv: "My CV.pdf",
        win_minesweeper_title: "Minesweeper",
        win_paint_title: "Paint - Untitled",
        ctx_refresh: "Refresh",
        ctx_new: "New",
        ctx_properties: "Properties",
        start_notepad: "Notepad",
        start_projects: "My Projects",
        start_skills: "Skills",
        start_cv: "My CV (FR)",
        start_cv_en: "My CV (EN)",
        start_about: "About",
        start_shutdown: "Shutdown...",
        win_about_title: "Louka's PC - Properties",
        about_system: "System :",
        about_system_val: "CS Student (BUT Info)",
        about_version: "Version :",
        about_location: "Location :",
        about_intro: "Welcome to my system! I am a developer passionate about Back-end, Java, and automation.",
        about_goal: "Looking for an internship for 2026.",
        notepad_file: "File",
        notepad_edit: "Edit",
        notepad_search: "Search",
        notepad_help: "Help",
        contact_intro: "You can contact me at:",
        contact_btn_copy: "Copy Address",
        ie_welcome: "Welcome to the Internet",
        paint_help: "For help, click Help in Help menu.",
        shutdown_text: "IT IS NOW SAFE TO TURN OFF<br>YOUR COMPUTER.",
        restart_hint: "(Click to restart)",
        win_properties_title: "Display Properties",
        prop_wallpaper: "Wallpaper",
        btn_apply: "Apply",
        btn_cancel: "Cancel",
        win_recycle_title: "Recycle Bin",
        win_calendar_title: "Calendar",
        detail_desc: "Description:",
        detail_tech: "Technologies:",
        detail_skills: "Skills:",
        detail_btn_see: "View Code / Demo",
        detail_btn_close: "Close",
        clippy_intro: "Hi! I see you're looking for a skilled dev. Need help?",
        clippy_dblclick: "Tip: Double-click icons to open them.",
        clippy_cv: "I see you're checking my CV. Great choice!",
        clippy_mine: "Don't forget to try Minesweeper!",
        clippy_projects: "Need a website? Louka is here for that!",
        clippy_matrix: "Type 'matrix' in the terminal for a cool effect.",
        clippy_wallpaper: "You can change the wallpaper with right-click!",

        // NEW ENHANCEMENTS keys
        start_taskmgr: "Task Manager",
        win_taskmgr_title: "Task Manager",
        winamp_playing: "PLAYING: SYNTHWAVE_MIX_2024.MP3",
        winamp_paused: "PAUSED",
        winamp_stopped: "STOPPED",

        // NEW ADDITIONS
        boot_sequence: "Starting LoukaOS 98...",
        bsod_fatal: "A fatal exception 0E has occurred at 0028:C0011E36 in VXD VMM(01) + 00010E36.",
        bsod_terminated: "The current application will be terminated.",
        bsod_press_any: "* Press any key to terminate the current application.",
        bsod_ctrl_alt: "* Press CTRL+ALT+DEL again to restart your computer.",
        bsod_continue: "Press any key to continue _",

        win_projects_explorer: "C:\\My Documents\\Projects",
        win_recycle_explorer: "C:\\Recycle Bin",

        file_abandoned: "Abandoned_Project_v1.doc",
        file_obsolete: "Obsolete_Data.xls",
        file_bug: "infinite_bug.js",

        cal_mo: "Mo", cal_tu: "Tu", cal_we: "We", cal_th: "Th", cal_fr: "Fr", cal_sa: "Sa", cal_su: "Su",

        winamp_marquee: "WINAMP 1.91 - DEMO MODE - NO AUDIO FILE LOADED",

        ie_github: "GitHub",
        ie_linkedin: "LinkedIn",

        notepad_placeholder: "Type something...",

        tool_pencil: "Pencil",
        tool_eraser: "Eraser",
        tool_clear: "Clear All",

        month_0: "January", month_1: "February", month_2: "March", month_3: "April", month_4: "May", month_5: "June",
        month_6: "July", month_7: "August", month_8: "September", month_9: "October", month_10: "November", month_11: "December"
    }
};

let currentLang = 'fr';

function toggleLanguage() {
    currentLang = currentLang === 'fr' ? 'en' : 'fr';
    updateLanguage();
}

function updateLanguage() {
    document.documentElement.lang = currentLang;

    // Update text elements
    document.querySelectorAll('[data-lang-key]').forEach(el => {
        const key = el.getAttribute('data-lang-key');
        if (translations[currentLang][key]) {
            if (el.tagName === 'INPUT' && el.type === 'button') {
                el.value = translations[currentLang][key];
            } else if (el.tagName === 'TEXTAREA' && key === 'notepad_placeholder') {
                el.placeholder = translations[currentLang][key];
            } else {
                el.innerHTML = translations[currentLang][key];
            }
        }
    });

    // Update Calendar if open
    if (document.getElementById('win-calendar').style.display === 'flex') {
        renderCalendar();
    }

    // Update Winamp Marquee
    const winampMarquee = document.querySelector('#win-winamp marquee');
    if (winampMarquee) winampMarquee.textContent = translations[currentLang]['winamp_marquee'];

    // Update toggle button text
    const toggle = document.querySelector('.lang-toggle');
    if (toggle) toggle.textContent = currentLang.toUpperCase();
}

// --- PROJECT DATA ---
const projectsData = {
    'bomberman': {
        title: 'Bomberman.jar',
        subtitle: 'Jeu Arcade / Arcade Game',
        icon: 'https://win98icons.alexmeub.com/icons/png/java-0.png',
        desc: {
            fr: "Impl√©mentation compl√®te du jeu Bomberman en Java/JavaFX. Projet universitaire ax√© sur l'architecture MVC et la gestion de projet avec Gradle. Inclut un √©diteur de niveau proc√©dural et une IA basique.",
            en: "Complete implementation of Bomberman in Java/JavaFX. University project focused on MVC architecture and Gradle project management. Includes a procedural level editor and basic AI."
        },
        tech: "Java 11+, JavaFX, Gradle, MVC",
        skills: {
            fr: ["Architecture MVC & Clean Code", "Gestion d'√©v√©nements & Multithreading", "G√©n√©ration Algorithmique (Procedural)"],
            en: ["MVC Architecture & Clean Code", "Event Handling & Multithreading", "Algorithmic Generation (Procedural)"]
        },
        link: "https://github.com/SaladeFetide/Projet-Bomberman"
    },
    'pokebattle': {
        title: 'PokeBattle.html',
        subtitle: 'Jeu Web / Web Game',
        icon: 'https://win98icons.alexmeub.com/icons/png/html-0.png',
        desc: {
            fr: "Simulateur de combat Pok√©mon au tour par tour. Utilise l'API Pok√©API pour r√©cup√©rer les statistiques et sprites en temps r√©el. logique de combat fid√®le.",
            en: "Turn-based Pok√©mon battle simulator. Uses Pok√©API to fetch stats and sprites in real-time. Faithful battle logic."
        },
        tech: "HTML5, CSS3, JavaScript (Vanilla), REST API",
        skills: {
            fr: ["Int√©gration API REST (Asynchrone/Promises)", "Manipulation DOM Avanc√©e", "Programmation Orient√©e Objet JS"],
            en: ["REST API Integration (Async/Promises)", "Advanced DOM Manipulation", "JS Object-Oriented Programming"]
        },
        link: "https://poke-battle-vert.vercel.app/"
    },
    'cocktails': {
        title: 'Cocktails.py',
        subtitle: 'App Web / Web App',
        icon: 'https://win98icons.alexmeub.com/icons/png/script_file_blue-0.png',
        desc: {
            fr: "Jeu de quiz interactif (Projet Agile/Scrum). Devinez les ingr√©dients des cocktails en temps limit√© ! Backend Flask robuste et Frontend Bulma responsive.",
            en: "Interactive quiz game (Agile/Scrum Project). Guess cocktail ingredients within the time limit! Robust Flask backend and responsive Bulma frontend."
        },
        tech: "Python (Flask), SQLite, Bulma CSS",
        skills: {
            fr: ["M√©thodologie Agile (Scrum/Jira)", "D√©veloppement Fullstack Python", "Mod√©lisation Base de Donn√©es Relationalle"],
            en: ["Agile Methodology (Scrum/Jira)", "Python Fullstack Development", "Relational Database Modeling"]
        },
        link: "https://github.com/SaladeFetide/TheCocktail"
    },
    'lensymphony': {
        title: 'LenSymphony.lib',
        subtitle: 'Biblioth√®que Audio / Audio Lib',
        icon: 'https://win98icons.alexmeub.com/icons/png/cd_audio_cd_a-3.png',
        desc: {
            fr: "Biblioth√®que Java pour la synth√®se musicale. Permet de mod√©liser notes, silences et port√©es pour jouer des partitions virtuelles via synth√®se audio.",
            en: "Java library for music synthesis. Allows modeling notes, rests, and staffs to play virtual scores via audio synthesis."
        },
        tech: "Java, Sound API, Data Structures",
        skills: {
            fr: ["D√©veloppement de Librairie & API", "Traitement Num√©rique du Signal", "Structures de Donn√©es Complexes"],
            en: ["Library & API Development", "Digital Signal Processing", "Complex Data Structures"]
        },
        link: "https://github.com/SaladeFetide/LenSymphony"
    },
    'onitama': {
        title: 'Onitama.exe',
        subtitle: 'Moteur de Jeu / Game Engine',
        icon: 'https://win98icons.alexmeub.com/icons/png/game_freecell-1.png',
        desc: {
            fr: "Moteur complet pour le jeu de soci√©t√© Onitama. Architecture modulaire exemplaire avec une IA Minimax int√©gr√©e pour le mode solo.",
            en: "Complete engine for the Onitama board game. Exemplary modular architecture with an integrated Minimax AI for solo mode."
        },
        tech: "Java 17+, Gradle, Minimax Algorithm",
        skills: {
            fr: ["IA & Th√©orie des Jeux (Minimax/Alpha-Beta)", "Algorithmique Avanc√©e", "Architecture Modulaire & Extensible"],
            en: ["AI & Game Theory (Minimax/Alpha-Beta)", "Advanced Algorithmics", "Modular & Extensible Architecture"]
        },
        link: "https://github.com/SaladeFetide/Onitama"
    },
    'fivem': {
        title: 'FiveM_Scripts.lua',
        subtitle: 'Scripts & Mods',
        icon: 'https://win98icons.alexmeub.com/icons/png/script_file_yellow-0.png',
        desc: {
            fr: "Scripts Lua optimis√©s pour serveurs GTA V RP. Cr√©ation d'interfaces (NUI), syst√®mes de m√©tiers et synchronisation client/serveur.",
            en: "Optimized Lua scripts for GTA V RP servers. Creation of UIs (NUI), job systems, and client/server synchronization."
        },
        tech: "Lua, SQL, HTML/JS (NUI)",
        skills: {
            fr: ["Scripting Lua & Optimisation", "Synchronisation R√©seau (NetCode)", "Interfaces Fullstack (NUI)"],
            en: ["Lua Scripting & Optimization", "Network Synchronization (NetCode)", "Fullstack Interfaces (NUI)"]
        },
        link: "https://github.com/SaladeFetide?tab=repositories"
    }
};

function openProjectDetail(id) {
    const project = projectsData[id];
    if (!project) return;

    // Update Icon and Title
    document.getElementById('detail-icon').src = project.icon;
    document.getElementById('detail-title').textContent = project.title;
    document.getElementById('detail-subtitle').textContent = project.subtitle;

    // We'll store the ID to handle language translation updates for the opened window
    document.getElementById('win-project-detail').dataset.currentProject = id;

    updateProjectDetailContent(id);

    document.getElementById('detail-link').href = project.link;

    openWindow('win-project-detail');
}

function updateProjectDetailContent(id) {
    if (!id) return;
    const project = projectsData[id];

    // Content based on lang
    document.getElementById('detail-desc').innerHTML = project.desc[currentLang] || project.desc.fr;
    document.getElementById('detail-tech').textContent = project.tech;

    const skillsList = document.getElementById('detail-skills');
    skillsList.innerHTML = '';
    const skills = project.skills[currentLang] || project.skills.fr;
    skills.forEach(skill => {
        const li = document.createElement('li');
        li.textContent = skill;
        skillsList.appendChild(li);
    });
}


// --- BOOT SEQUENCE ---
// Boot logic moved to simulateModem in new onload override at bottom
// setupKeyboardAccessibility(); // also moved


function setupKeyboardAccessibility() {
    // Make elements with role="button" clickable via Enter key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            const el = document.activeElement;
            if (el && el.getAttribute('role') === 'button') {
                el.click(); // Trigger click
                if (el.getAttribute('ondblclick')) {
                    // For desktop icons, they are set to open on double click, 
                    // but accessibility wise Enter should probably open them.
                    // The click listener on them (if any) or dblclick needs handling.
                    // Let's just manually trigger map
                    const dblclick = el.getAttribute('ondblclick');
                    if (dblclick) new Function(dblclick)();
                }
            }
        }
    });

    // Make window controls focusable? Maybe overkill, but good for navigation
}

function playStartupSound() {
    const audio = new Audio('https://www.myinstants.com/media/sounds/windows-98-startup.mp3');
    audio.play().catch(e => console.log("Audio autoplay blocked:", e));
}

// --- SONS CLIC ---
const clickAudio = new Audio('https://www.myinstants.com/media/sounds/windows-98-click.mp3');
document.addEventListener('mousedown', () => {
    clickAudio.currentTime = 0;
    clickAudio.play().catch(() => { });
});

// --- MENU D√âMARRER ---
const startMenu = document.getElementById('start-menu');
const startBtn = document.getElementById('start-btn');

startBtn.onclick = function (e) {
    e.stopPropagation();
    const isVisible = startMenu.style.display === 'flex';
    startMenu.style.display = isVisible ? 'none' : 'flex';
    startBtn.classList.toggle('active');
};

document.addEventListener('click', function (e) {
    if (!startMenu.contains(e.target) && e.target !== startBtn) {
        startMenu.style.display = 'none';
        startBtn.classList.remove('active');
    }
});

// --- HORLOGE & DATE ---
function updateClock() {
    const now = new Date();
    let hours = now.getHours();
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12;
    const timeStr = `${hours}:${minutes} ${ampm}`;

    const clockEl = document.getElementById('clock');
    clockEl.textContent = timeStr;

    // Tooltip avec la date compl√®te
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    clockEl.title = now.toLocaleDateString(currentLang === 'fr' ? 'fr-FR' : 'en-US', options);
}
setInterval(updateClock, 1000);
updateClock();

// --- BSOD ---
function triggerBSOD() {
    document.getElementById('bsod').style.display = 'block';
}

// --- MATRIX RAIN EFFECT ---
// (Logic moved to bottom of file or implemented in one place)

// --- GESTION FEN√äTRES & BARRE DES T√ÇCHES ---
const taskbarApps = document.getElementById('taskbar-apps');

// Map pour stocker les infos des fen√™tres (titre, ic√¥ne)
const windowsInfo = {
    'win-about': { title: 'Poste de Louka', icon: 'https://win98icons.alexmeub.com/icons/png/computer_explorer-4.png' },
    'win-projects': { title: 'Mes Projets', icon: 'https://win98icons.alexmeub.com/icons/png/directory_open_file_mydocs-4.png' },
    'win-skills': { title: 'Comp√©tences.exe', icon: 'https://win98icons.alexmeub.com/icons/png/game_solitaire-1.png' },
    'win-notepad': { title: 'Bloc-notes', icon: 'https://win98icons.alexmeub.com/icons/png/notepad-5.png' },
    'win-contact': { title: 'Contact', icon: 'https://win98icons.alexmeub.com/icons/png/outlook_express-4.png' },
    'win-ie': { title: 'Internet Explorer', icon: 'https://win98icons.alexmeub.com/icons/png/msie1-2.png' },
    'win-terminal': { title: 'MS-DOS Prompt', icon: 'https://win98icons.alexmeub.com/icons/png/console_prompt-0.png' },
    'win-winamp': { title: 'Winamp', icon: 'https://win98icons.alexmeub.com/icons/png/cd_audio_cd_a-3.png' },
    'win-minesweeper': { title: 'D√©mineur', icon: 'https://win98icons.alexmeub.com/icons/png/game_mine_1-0.png' },
    'win-paint': { title: 'Paint', icon: 'https://win98icons.alexmeub.com/icons/png/paint_file-2.png' },
    'win-recycle': { title: 'Corbeille', icon: 'https://win98icons.alexmeub.com/icons/png/recycle_bin_full-4.png' },
    'win-calendar': { title: 'Calendrier', icon: 'https://win98icons.alexmeub.com/icons/png/calendar-1.png' },
    'win-project-detail': { title: 'Details', icon: 'https://win98icons.alexmeub.com/icons/png/chm-1.png' },
    'win-taskmgr': { title: 'Task Manager', icon: 'https://win98icons.alexmeub.com/icons/png/computer_task_manager-0.png' }
};

function openWindow(id) {
    const win = document.getElementById(id);
    win.style.display = 'flex';
    bringToFront(win);
    updateTaskbar(id, true);

    if (id === 'win-taskmgr') {
        startTaskManager();
    }
}

function closeWindow(id) {
    document.getElementById(id).style.display = 'none';

    if (id === 'win-taskmgr') {
        stopTaskManager();
    }

    // Retirer de la barre des t√¢ches
    const appBtn = document.getElementById('btn-' + id);
    if (appBtn) appBtn.remove();
}

function minimizeWindow(id) {
    const win = document.getElementById(id);
    win.style.display = 'none';
    // Le bouton reste dans la barre des t√¢ches mais perd la classe active
    const appBtn = document.getElementById('btn-' + id);
    if (appBtn) appBtn.classList.remove('active');
}

// Stockage √©tat avant maximisation
const restoreState = {};

function maximizeWindow(id) {
    const win = document.getElementById(id);

    if (win.dataset.maximized === 'true') {
        // RESTORE
        win.style.top = restoreState[id].top;
        win.style.left = restoreState[id].left;
        win.style.width = restoreState[id].width;
        win.style.height = restoreState[id].height;
        win.dataset.maximized = 'false';
    } else {
        // MAXIMIZE
        restoreState[id] = {
            top: win.style.top,
            left: win.style.left,
            width: win.style.width,
            height: win.style.height
        };
        win.style.top = '0';
        win.style.left = '0';
        win.style.width = '100%';
        win.style.height = 'calc(100% - 40px)'; // Minus taskbar
        win.dataset.maximized = 'true';
    }
    bringToFront(win);

    // Resize Doom canvas if it's the Doom window
    if (id === 'win-doom' && typeof resizeCanvas === 'function') {
        setTimeout(() => resizeCanvas(), 100);
    }
}

function toggleWindow(id) {
    const win = document.getElementById(id);
    const appBtn = document.getElementById('btn-' + id);

    if (win.style.display === 'none') {
        win.style.display = 'flex';
        bringToFront(win);
        appBtn.classList.add('active');
    } else {
        // Si d√©j√† actif et au premier plan, on minimise
        if (win.style.zIndex == 10) {
            minimizeWindow(id);
        } else {
            // Sinon on met au premier plan
            bringToFront(win);
        }
    }
}

function updateTaskbar(id, isActive) {
    let appBtn = document.getElementById('btn-' + id);

    // Cr√©er le bouton s'il n'existe pas
    if (!appBtn) {
        appBtn = document.createElement('div');
        appBtn.id = 'btn-' + id;
        appBtn.className = 'taskbar-app';
        appBtn.onclick = () => toggleWindow(id);

        const info = windowsInfo[id] || { title: 'Application', icon: '' };

        appBtn.innerHTML = `<img src="${info.icon}"><span>${info.title}</span>`;
        taskbarApps.appendChild(appBtn);
    }

    // G√©rer l'√©tat actif
    document.querySelectorAll('.taskbar-app').forEach(btn => btn.classList.remove('active'));
    if (isActive) appBtn.classList.add('active');
}

function bringToFront(element) {
    // Mettre toutes les fen√™tres en inactif
    document.querySelectorAll('.window').forEach(w => {
        w.style.zIndex = 1;
        w.classList.add('inactive');
    });

    // Activer la fen√™tre cible
    element.style.zIndex = 10;
    element.classList.remove('inactive');

    // Mettre √† jour la barre des t√¢ches
    document.querySelectorAll('.taskbar-app').forEach(btn => btn.classList.remove('active'));
    const btn = document.getElementById('btn-' + element.id);
    if (btn) btn.classList.add('active');
}

// --- DRAG & DROP (FEN√äTRES & IC√îNES) ---
let isDragging = false;
let dragType = null; // 'window' or 'icon'
let currentElement = null;
let offsetX, offsetY;

function startDrag(e, windowEl) {
    isDragging = true;
    dragType = 'window';
    currentElement = windowEl;
    bringToFront(windowEl);

    if (windowEl.dataset.maximized === 'true') {
        isDragging = false;
        return;
    }

    offsetX = e.clientX - windowEl.getBoundingClientRect().left;
    offsetY = e.clientY - windowEl.getBoundingClientRect().top;
}

function startIconDrag(e, iconEl) {
    e.stopPropagation(); // Emp√™che de cliquer sur le bureau
    isDragging = true;
    dragType = 'icon';
    currentElement = iconEl;
    currentElement.classList.add('dragging');

    offsetX = e.clientX - iconEl.getBoundingClientRect().left;
    offsetY = e.clientY - iconEl.getBoundingClientRect().top;
}

document.addEventListener('mousemove', (e) => {
    if (!isDragging || !currentElement) return;

    const x = e.clientX - offsetX;
    const y = e.clientY - offsetY;

    if (dragType === 'window') {
        currentElement.style.left = `${x}px`;
        currentElement.style.top = `${y}px`;
    } else if (dragType === 'icon') {
        currentElement.style.left = `${x}px`;
        currentElement.style.top = `${y}px`;
    }
});

document.addEventListener('mouseup', () => {
    if (isDragging && dragType === 'icon' && currentElement) {
        currentElement.classList.remove('dragging');
        saveIconPositions(); // Save on drop
    }
    isDragging = false;
    currentElement = null;
    dragType = null;
});

// --- ICON PERSISTENCE ---
function saveIconPositions() {
    const icons = document.querySelectorAll('.icon');
    const positions = [];
    icons.forEach((icon, index) => {
        positions.push({
            index: index, // This relies on DOM order, which might change? Better to use text as key but index is fine for now
            left: icon.style.left,
            top: icon.style.top
        });
    });
    localStorage.setItem('iconPositions', JSON.stringify(positions));
}

function loadIconPositions() {
    const saved = localStorage.getItem('iconPositions');
    if (saved) {
        const positions = JSON.parse(saved);
        const icons = document.querySelectorAll('.icon');
        // Simple heuristic matching by index
        positions.forEach(pos => {
            if (icons[pos.index]) {
                icons[pos.index].style.left = pos.left;
                icons[pos.index].style.top = pos.top;
            }
        });
    }
}

// --- CONTEXT MENU (CLIC DROIT) ---
const ctxMenu = document.getElementById('context-menu');

document.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    ctxMenu.style.display = 'flex';
    ctxMenu.style.left = e.clientX + 'px';
    ctxMenu.style.top = e.clientY + 'px';
});

document.addEventListener('click', (e) => {
    if (!ctxMenu.contains(e.target)) {
        ctxMenu.style.display = 'none';
    }
});

setTimeout(() => openWindow('win-about'), 3100);

function copyEmail() {
    const email = "louka.riquoir@gmail.com";
    navigator.clipboard.writeText(email).then(() => {
        alert("Email copi√© dans le presse-papier !");
    }).catch(err => {
        alert("Erreur lors de la copie.");
    });
}

// --- TERMINAL (MS-DOS) ---
const cmdInput = document.getElementById('cmd-input');
const terminalOutput = document.getElementById('terminal-output');

if (cmdInput) {
    cmdInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
            const command = this.value.trim().toLowerCase();
            this.value = '';

            terminalOutput.innerHTML += `<div>C:\\WINDOWS> ${command}</div>`;

            let response = '';
            switch (command) {
                case 'help':
                    response = 'COMMANDS: HELP, ABOUT, SKILLS, PROJECTS, CONTACT, CLEAR, EXIT';
                    break;
                case 'about':
                    response = 'LOUKA RIQUOIR - ETUDIANT BUT INFORMATIQUE - PASSIONNE DE BACK-END.';
                    break;
                case 'skills':
                    response = 'JAVA, PYTHON, LUA, SQL, LINUX, GIT...';
                    break;
                case 'projects':
                    response = 'OPENING PROJECTS FOLDER...';
                    openWindow('win-projects');
                    break;
                case 'contact':
                    response = 'OPENING CONTACT...';
                    openWindow('win-contact');
                    break;
                case 'matrix':
                    startMatrix();
                    return;
                case 'clear':
                    terminalOutput.innerHTML = '';
                    return;
                case 'exit':
                    closeWindow('win-terminal');
                    return;
                case '':
                    break;
                default:
                    response = 'Bad command or file name';
            }

            if (response) {
                terminalOutput.innerHTML += `<div>${response}</div>`;
            }
            terminalOutput.innerHTML += '<br>';

            const contentArea = document.getElementById('terminal-content');
            contentArea.scrollTop = contentArea.scrollHeight;
        }
    });
}

// --- D√âMINEUR ---
let mineGrid = [];
let mineRows = 9;
let mineCols = 9;
let mineCount = 10;
let mineFlags = 0;
let mineGameOver = false;
let mineTimerInterval;
let mineTime = 0;

function initMinesweeper() {
    const gridEl = document.getElementById('mine-grid');
    gridEl.innerHTML = '';
    mineGrid = [];
    mineFlags = 0;
    mineGameOver = false;
    mineTime = 0;
    document.getElementById('mine-count').textContent = String(mineCount).padStart(3, '0');
    document.getElementById('mine-timer').textContent = '000';
    clearInterval(mineTimerInterval);
    mineTimerInterval = setInterval(() => {
        if (!mineGameOver) {
            mineTime++;
            document.getElementById('mine-timer').textContent = String(Math.min(999, mineTime)).padStart(3, '0');
        }
    }, 1000);

    document.querySelector('.smiley-btn').textContent = 'üòä';

    for (let r = 0; r < mineRows; r++) {
        let row = [];
        for (let c = 0; c < mineCols; c++) {
            let cell = {
                r, c,
                isMine: false,
                isRevealed: false,
                isFlagged: false,
                neighbors: 0,
                el: document.createElement('div')
            };
            cell.el.className = 'mine-cell';
            cell.el.onmousedown = (e) => handleMineClick(e, r, c);
            cell.el.oncontextmenu = (e) => { e.preventDefault(); };
            gridEl.appendChild(cell.el);
            row.push(cell);
        }
        mineGrid.push(row);
    }

    let minesPlaced = 0;
    while (minesPlaced < mineCount) {
        let r = Math.floor(Math.random() * mineRows);
        let c = Math.floor(Math.random() * mineCols);
        if (!mineGrid[r][c].isMine) {
            mineGrid[r][c].isMine = true;
            minesPlaced++;
        }
    }

    for (let r = 0; r < mineRows; r++) {
        for (let c = 0; c < mineCols; c++) {
            if (!mineGrid[r][c].isMine) {
                let count = 0;
                for (let i = -1; i <= 1; i++) {
                    for (let j = -1; j <= 1; j++) {
                        if (r + i >= 0 && r + i < mineRows && c + j >= 0 && c + j < mineCols) {
                            if (mineGrid[r + i][c + j].isMine) count++;
                        }
                    }
                }
                mineGrid[r][c].neighbors = count;
            }
        }
    }
}

function handleMineClick(e, r, c) {
    if (mineGameOver) return;
    const cell = mineGrid[r][c];

    if (e.button === 2) {
        if (!cell.isRevealed) {
            cell.isFlagged = !cell.isFlagged;
            cell.el.textContent = cell.isFlagged ? 'üö©' : '';
            cell.el.classList.toggle('flag');
            mineFlags += cell.isFlagged ? 1 : -1;
            document.getElementById('mine-count').textContent = String(mineCount - mineFlags).padStart(3, '0');
        }
    } else if (e.button === 0) {
        if (cell.isFlagged) return;
        if (cell.isMine) {
            gameOver(false);
        } else {
            revealCell(r, c);
            checkWin();
        }
    }
}

// --- WINAMP LOGIC ---
const winampTracks = [
    "https://upload.wikimedia.org/wikipedia/commons/d/d9/Wilhelm_Scream.ogg", // Placeholder
    "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" // Demo song
];
let winampIsPlaying = false;
const winampAudio = document.getElementById('winamp-audio');

function winampPlay() {
    if (!winampAudio.src) {
        winampAudio.src = winampTracks[1];
        winampAudio.volume = 0.3;
    }
    winampAudio.play().then(() => {
        winampIsPlaying = true;
        updateWinampStatus();
    }).catch(e => console.error("Audio play failed", e));
}

function winampPause() {
    winampAudio.pause();
    winampIsPlaying = false;
    updateWinampStatus();
}

function winampStop() {
    winampAudio.pause();
    winampAudio.currentTime = 0;
    winampIsPlaying = false;
    updateWinampStatus();
}

function winampNext() {
    // Just restart for demo
    winampAudio.currentTime = 0;
    winampAudio.play();
}

function winampPrev() {
    winampAudio.currentTime = 0;
    winampAudio.play();
}

function updateWinampStatus() {
    const marquee = document.getElementById('winamp-marquee');
    const status = document.getElementById('winamp-status');

    if (!marquee) return;

    if (winampIsPlaying) {
        marquee.textContent = translations[currentLang]?.winamp_playing || "PLAYING...";
        if (status) status.textContent = "PLAYING";
        marquee.scrollAmount = 4;
    } else {
        if (winampAudio.currentTime > 0) {
            marquee.textContent = translations[currentLang]?.winamp_paused || "PAUSED";
            if (status) status.textContent = "PAUSED";
            marquee.scrollAmount = 0;
        } else {
            marquee.textContent = translations[currentLang]?.winamp_stopped || "STOPPED";
            if (status) status.textContent = "STOPPED";
            marquee.scrollAmount = 0;
        }
    }
}

// Volume control
const winampVol = document.getElementById('winamp-vol');
if (winampVol) {
    winampVol.addEventListener('input', (e) => {
        if (winampAudio) winampAudio.volume = e.target.value;
    });
}
if (winampAudio) {
    winampAudio.addEventListener('timeupdate', () => {
        const timer = document.getElementById('winamp-timer');
        if (timer) {
            const min = Math.floor(winampAudio.currentTime / 60);
            const sec = Math.floor(winampAudio.currentTime % 60);
            timer.textContent = `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        }
    });
}


// --- TASK MANAGER LOGIC ---
let taskMgrInterval;

function startTaskManager() {
    if (taskMgrInterval) clearInterval(taskMgrInterval);
    updateTaskMgr();
    taskMgrInterval = setInterval(updateTaskMgr, 1500);
}

function stopTaskManager() {
    clearInterval(taskMgrInterval);
}

function updateTaskMgr() {
    const list = document.getElementById('taskmgr-list');
    if (!list) return;

    // Mock processes
    const processes = [
        { name: "System Idle Process", cpu: Math.floor(Math.random() * 90), mem: "16 K" },
        { name: "java_backend.exe", cpu: Math.floor(Math.random() * 5), mem: "14,020 K" },
        { name: "louka_brain.sys", cpu: Math.floor(Math.random() * 2), mem: "99,999 K" },
        { name: "explorer.exe", cpu: 1, mem: "4,500 K" },
        { name: "winamp.exe", cpu: 0, mem: "2,300 K" },
        { name: "taskmgr.exe", cpu: 2, mem: "1,200 K" },
        { name: "skills_scan.dll", cpu: 0, mem: "120 K" },
        { name: "fivem_server.lua", cpu: 0, mem: "8,400 K" },
        { name: "laravel_artisan", cpu: 0, mem: "6,100 K" },
    ];

    // Sort by CPU
    processes.sort((a, b) => b.cpu - a.cpu);

    let html = '<table style="width:100%; border-collapse:collapse;">';
    processes.forEach(p => {
        html += `<tr>
            <td>${p.name}</td>
            <td style="text-align:right">${p.cpu} %</td>
            <td style="text-align:right">${p.mem}</td>
        </tr>`;
    });
    html += '</table>';

    list.innerHTML = html;

    // Update footer stats
    const totalCpu = processes.reduce((acc, p) => acc + (p.name === 'System Idle Process' ? 0 : p.cpu), 0);
    const cpuEl = document.getElementById('taskmgr-cpu');
    const memEl = document.getElementById('taskmgr-mem');
    if (cpuEl) cpuEl.textContent = totalCpu + "%";
    if (memEl) memEl.textContent = Math.floor(Math.random() * 20 + 10) + "%";
}

function gameOver(won) {
    mineGameOver = true;
    clearInterval(mineTimerInterval);
    document.querySelector('.smiley-btn').textContent = won ? 'üòé' : 'üòµ';

    if (!won) {
        for (let r = 0; r < mineRows; r++) {
            for (let c = 0; c < mineCols; c++) {
                if (mineGrid[r][c].isMine) {
                    mineGrid[r][c].el.classList.add('revealed', 'mine');
                    mineGrid[r][c].el.textContent = 'üí£';
                }
            }
        }
    }
}

function checkWin() {
    let revealedCount = 0;
    for (let r = 0; r < mineRows; r++) {
        for (let c = 0; c < mineCols; c++) {
            if (mineGrid[r][c].isRevealed) revealedCount++;
        }
    }
    if (revealedCount === (mineRows * mineCols - mineCount)) {
        gameOver(true);
    }
}

initMinesweeper();

// --- MOBILE OPTIMIZATIONS ---
if (window.innerWidth <= 768) {
    document.querySelectorAll('.icon').forEach(icon => {
        icon.addEventListener('click', (e) => {
            const action = icon.getAttribute('ondblclick');
            if (action) {
                new Function(action)();
            }
        });
    });
}

// --- MATRIX EFFECT ---
let matrixInterval;
function startMatrix() {
    const canvas = document.getElementById('matrix-canvas');
    const ctx = canvas.getContext('2d');
    const terminalContent = document.getElementById('terminal-content');

    canvas.style.display = 'block';
    canvas.width = terminalContent.clientWidth;
    canvas.height = terminalContent.clientHeight;

    const katakana = '„Ç¢„Ç°„Ç´„Çµ„Çø„Éä„Éè„Éû„É§„É£„É©„ÉØ„Ç¨„Ç∂„ÉÄ„Éê„Éë„Ç§„Ç£„Ç≠„Ç∑„ÉÅ„Éã„Éí„Éü„É™„É∞„ÇÆ„Ç∏„ÉÇ„Éì„Éî„Ç¶„Ç•„ÇØ„Çπ„ÉÑ„Éå„Éï„É†„É¶„É•„É´„Ç∞„Ç∫„Éñ„ÉÖ„Éó„Ç®„Çß„Ç±„Çª„ÉÜ„Éç„Éò„É°„É¨„É±„Ç≤„Çº„Éá„Éô„Éö„Ç™„Ç©„Ç≥„ÇΩ„Éà„Éé„Éõ„É¢„É®„Éß„É≠„É≤„Ç¥„Çæ„Éâ„Éú„Éù„É¥„ÉÉ„É≥0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const latin = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    const nums = '0123456789';
    const alphabet = katakana + latin + nums;

    const fontSize = 16;
    const columns = canvas.width / fontSize;

    const rainDrops = [];
    for (let x = 0; x < columns; x++) {
        rainDrops[x] = 1;
    }

    const draw = () => {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = '#0F0';
        ctx.font = fontSize + 'px monospace';

        for (let i = 0; i < rainDrops.length; i++) {
            const text = alphabet.charAt(Math.floor(Math.random() * alphabet.length));
            ctx.fillText(text, i * fontSize, rainDrops[i] * fontSize);

            if (rainDrops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                rainDrops[i] = 0;
            }
            rainDrops[i]++;
        }
    };

    if (matrixInterval) clearInterval(matrixInterval);
    matrixInterval = setInterval(draw, 30);

    const stopMatrix = () => {
        clearInterval(matrixInterval);
        canvas.style.display = 'none';
        document.removeEventListener('click', stopMatrix);
        document.removeEventListener('keydown', stopMatrix);
    };
    setTimeout(() => {
        document.addEventListener('click', stopMatrix);
        document.addEventListener('keydown', stopMatrix);
    }, 500);
}

// --- PAINT APP ---
let paintCtx, paintCanvas;
let isPainting = false;
let currentTool = 'pencil';
let currentColor = '#000000';

function initPaint() {
    paintCanvas = document.getElementById('paint-canvas');
    paintCtx = paintCanvas.getContext('2d');

    paintCtx.fillStyle = 'white';
    paintCtx.fillRect(0, 0, paintCanvas.width, paintCanvas.height);

    const colors = ['#000000', '#808080', '#800000', '#808000', '#008000', '#008080', '#000080', '#800080', '#808040', '#004040', '#0080FF', '#004080', '#4000FF', '#804000',
        '#FFFFFF', '#C0C0C0', '#FF0000', '#FFFF00', '#00FF00', '#00FFFF', '#0000FF', '#FF00FF', '#FFFF80', '#00FF80', '#80FFFF', '#8080FF', '#FF80FF', '#FF8040'];

    const palette = document.getElementById('color-palette');
    colors.forEach((c, i) => {
        const swatch = document.createElement('div');
        swatch.className = 'color-swatch';
        swatch.style.backgroundColor = c;
        if (i === 0) swatch.classList.add('active');
        swatch.onclick = () => selectColor(c, swatch);
        palette.appendChild(swatch);
    });

    paintCanvas.addEventListener('mousedown', startPainting);
    paintCanvas.addEventListener('mousemove', drawPaint);
    paintCanvas.addEventListener('mouseup', stopPainting);
    paintCanvas.addEventListener('mouseleave', stopPainting);
}

function selectTool(tool) {
    currentTool = tool;
    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tool-' + tool).classList.add('active');
}

function selectColor(color, el) {
    currentColor = color;
    document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
    el.classList.add('active');
}

function clearCanvas() {
    paintCtx.fillStyle = 'white';
    paintCtx.fillRect(0, 0, paintCanvas.width, paintCanvas.height);
}

function startPainting(e) {
    isPainting = true;
    drawPaint(e);
}

function stopPainting() {
    isPainting = false;
    paintCtx.beginPath();
}

function drawPaint(e) {
    if (!isPainting) return;

    const rect = paintCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    paintCtx.lineWidth = 2;
    paintCtx.lineCap = 'round';

    if (currentTool === 'pencil') {
        paintCtx.strokeStyle = currentColor;
        paintCtx.lineTo(x, y);
        paintCtx.stroke();
        paintCtx.beginPath();
        paintCtx.moveTo(x, y);
    } else if (currentTool === 'eraser') {
        paintCtx.fillStyle = 'white';
        paintCtx.fillRect(x - 5, y - 5, 10, 10);
    }
}

// --- NOTEPAD ---
function initNotepad() {
    const savedText = localStorage.getItem('notepad-content');
    if (savedText) {
        document.getElementById('notepad-content').value = savedText;
    }
}

function autoSaveNotepad() {
    const text = document.getElementById('notepad-content').value;
    localStorage.setItem('notepad-content', text);
}

function saveNotepad() {
    autoSaveNotepad();
    alert("Fichier enregistr√© avec succ√®s !");
}

// --- CALENDAR ---
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();

function renderCalendar() {
    const monthNamesFr = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];
    const monthNamesEn = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

    const monthNames = currentLang === 'fr' ? monthNamesFr : monthNamesEn;

    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const firstDay = new Date(currentYear, currentMonth, 1).getDay(); // 0 = Sunday

    document.getElementById('calendar-month-year').textContent = `${monthNames[currentMonth]} ${currentYear}`;

    const tbody = document.getElementById('calendar-body');
    tbody.innerHTML = '';

    let date = 1;
    for (let i = 0; i < 6; i++) {
        const row = document.createElement('tr');
        for (let j = 0; j < 7; j++) {
            const cell = document.createElement('td');
            if (i === 0 && j < firstDay) {
                cell.textContent = '';
            } else if (date > daysInMonth) {
                break;
            } else {
                cell.textContent = date;
                const today = new Date();
                if (date === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear()) {
                    cell.classList.add('today');
                }
                date++;
            }
            row.appendChild(cell);
        }
        tbody.appendChild(row);
    }
}

function changeMonth(delta) {
    currentMonth += delta;
    if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
    } else if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
    }
    renderCalendar();
}

// --- FAKE DOWNLOAD ---
function downloadCV() {
    const filename = currentLang === 'en' ? 'CV_EN.pdf' : 'CV_LOUKA_RIQUOIR.pdf';
    const filepath = `assets/docs/${filename}`;

    const win = document.getElementById('win-download');
    // Update text content of download window if open, but simple toggle here
    // We really should update the text inside the window before showing it

    // Simulating updating the window content
    const winTitle = win.querySelector('.title-bar span');
    if (winTitle) winTitle.textContent = currentLang === 'en' ? 'File Download' : 'T√©l√©chargement de fichier';

    const winContent = win.querySelector('.content-area div div div strong');
    if (winContent) winContent.textContent = filename;

    // ... rest of logic

    win.style.display = 'flex';
    bringToFront(win);

    let progress = 0;
    const bar = document.getElementById('download-bar');
    bar.style.width = '0%';

    const interval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress >= 100) {
            progress = 100;
            clearInterval(interval);
            setTimeout(() => {
                closeWindow('win-download');
                window.open(filepath, '_blank');
            }, 500);
        }
        bar.style.width = progress + '%';
    }, 200);
}

// --- SHUTDOWN ---
function triggerShutdown() {
    // Fade out effect
    document.body.style.transition = "filter 1s ease";
    document.body.style.filter = "grayscale(100%) brightness(0.5)";

    setTimeout(() => {
        document.getElementById('shutdown-screen').style.display = 'flex';
        document.body.style.filter = "none";
    }, 1000);
}

// --- CLIPPY ---
const clippyPhrasesKeys = [
    "clippy_intro",
    "clippy_dblclick",
    "clippy_cv",
    "clippy_mine",
    "clippy_projects",
    "clippy_matrix",
    "clippy_wallpaper"
];

function clippyTalk() {
    const bubble = document.getElementById('clippy-text');
    const randomKey = clippyPhrasesKeys[Math.floor(Math.random() * clippyPhrasesKeys.length)];
    bubble.textContent = translations[currentLang][randomKey] || translations.fr[randomKey];

    const clippy = document.getElementById('clippy');
    clippy.style.display = 'flex';

    // Hide after 5 seconds
    setTimeout(() => {
        clippy.style.display = 'none';
    }, 5000);
}

// Show clippy randomly
setInterval(() => {
    if (Math.random() > 0.7) clippyTalk();
}, 30000);

// --- SELECTION BOX ---
const selectionBox = document.getElementById('selection-box');
let startX, startY;
let isSelecting = false;

document.addEventListener('mousedown', (e) => {
    if (e.target.id === 'desktop') {
        isSelecting = true;
        startX = e.clientX;
        startY = e.clientY;
        selectionBox.style.left = startX + 'px';
        selectionBox.style.top = startY + 'px';
        selectionBox.style.width = '0px';
        selectionBox.style.height = '0px';
        selectionBox.style.display = 'block';
    }
});

document.addEventListener('mousemove', (e) => {
    if (!isSelecting) return;

    const currentX = e.clientX;
    const currentY = e.clientY;

    const width = Math.abs(currentX - startX);
    const height = Math.abs(currentY - startY);
    const left = Math.min(currentX, startX);
    const top = Math.min(currentY, startY);

    selectionBox.style.width = width + 'px';
    selectionBox.style.height = height + 'px';
    selectionBox.style.left = left + 'px';
    selectionBox.style.top = top + 'px';
});

document.addEventListener('mouseup', () => {
    isSelecting = false;
    selectionBox.style.display = 'none';
});

// --- WALLPAPER PREVIEW ---
function updatePreview() {
    const select = document.getElementById('wallpaper-select');
    const preview = document.getElementById('preview-screen');
    const value = select.value;

    // Check if it's a color or image (simplified logic)
    switch (value) {
        case 'teal': preview.style.background = '#008080'; break;
        case 'red': preview.style.background = '#800000'; break;
        case 'black': preview.style.background = '#000000'; break;
        case 'clouds':
            preview.style.background = 'url("https://win98icons.alexmeub.com/images/clouds.jpg") no-repeat center center';
            preview.style.backgroundSize = 'cover';
            break;
        case 'matrix':
            preview.style.background = 'black';
            // In a real app we might show a static matrix image
            break;
        default: preview.style.background = '#008080';
    }
}

// --- THEME LOGIC ---
function applyThemeUser(theme) {
    document.body.className = ''; // Reset
    if (theme && theme !== 'default') {
        document.body.classList.add('theme-' + theme);
    }
}

// --- FILE SYSTEM LOGIC ---
const fileSystem = {
    "C:": {
        type: "folder",
        children: {
            "Mes Documents": {
                type: "folder",
                children: {
                    "Projets": {
                        type: "folder",
                        children: {
                            "Bomberman": { type: "folder", children: {} },
                            "Onitama": { type: "folder", children: {} },
                            "PokeBattle": { type: "folder", children: {} }
                        }
                    },
                    "CV_FR.pdf": { type: "file", icon: "pdf", action: "downloadCV('fr')" },
                    "CV_EN.pdf": { type: "file", icon: "pdf", action: "downloadCV('en')" },
                    "secret.txt": { type: "file", icon: "txt", content: "Bravo ! Vous avez trouv√© un fichier cach√©." }
                }
            },
            "Program Files": {
                type: "folder",
                children: {
                    "Visual J++": { type: "file", icon: "vscode", action: "openWindow('win-vscode')" },
                    "Internet Explorer": { type: "file", icon: "ie", action: "openWindow('win-ie')" },
                    "Winamp": { type: "file", icon: "winamp", action: "openWindow('win-winamp')" },
                    "System32": { type: "folder", children: {} }
                }
            },
            "Windows": {
                type: "folder",
                children: {
                    "System32": { type: "folder", children: {} }
                }
            }
        }
    }
};

let currentPath = [];

function openExplorer(pathStr) {
    if (!pathStr) pathStr = "C:";

    // Parse path string to array
    const parts = pathStr.split('/').filter(p => p);
    currentPath = parts;

    // Traverse
    let currentDir = fileSystem;
    let valid = true;
    if (!fileSystem[parts[0]]) valid = false;
    else currentDir = fileSystem[parts[0]];

    for (let i = 1; i < parts.length; i++) {
        if (currentDir.children && currentDir.children[parts[i]]) {
            currentDir = currentDir.children[parts[i]];
        } else {
            valid = false;
            break;
        }
    }

    if (!valid || currentDir.type !== 'folder') {
        alert("Chemin introuvable : " + pathStr);
        return;
    }

    // Render
    const win = document.getElementById('win-explorer');
    win.style.display = 'flex';
    bringToFront(win);
    updateTaskbar('win-explorer', true);

    document.getElementById('explorer-title').textContent = pathStr;
    document.getElementById('explorer-address').value = pathStr;

    const content = document.getElementById('explorer-content');
    content.innerHTML = '';

    // "Up" button if not root
    if (parts.length > 1) {
        const upDiv = document.createElement('div');
        upDiv.className = 'dir-item';
        upDiv.ondblclick = () => {
            parts.pop();
            openExplorer(parts.join('/'));
        };
        upDiv.innerHTML = `
            <img src="https://win98icons.alexmeub.com/icons/png/directory_open_file_mydocs-4.png" class="dir-icon">
            <div class="dir-text">..</div>
        `;
        content.appendChild(upDiv);
    }

    const items = currentDir.children || {};
    const count = Object.keys(items).length;
    document.getElementById('explorer-status').textContent = `${count} object(s)`;

    for (const [name, data] of Object.entries(items)) {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'dir-item';

        let iconUrl = "https://win98icons.alexmeub.com/icons/png/directory_closed-4.png";
        if (data.type === 'file') {
            if (data.icon === 'pdf') iconUrl = "https://win98icons.alexmeub.com/icons/png/chm-1.png";
            else if (data.icon === 'txt') iconUrl = "https://win98icons.alexmeub.com/icons/png/notepad-5.png";
            else if (data.icon === 'vscode') iconUrl = "https://win98icons.alexmeub.com/icons/png/template_empty-2.png";
            else if (data.icon === 'ie') iconUrl = "https://win98icons.alexmeub.com/icons/png/msie1-2.png";
            else if (data.icon === 'winamp') iconUrl = "https://win98icons.alexmeub.com/icons/png/cd_audio_cd_a-3.png";
        }

        itemDiv.innerHTML = `
            <img src="${iconUrl}" class="dir-icon">
            <div class="dir-text">${name}</div>
        `;

        if (data.type === 'folder') {
            itemDiv.ondblclick = () => openExplorer(pathStr + "/" + name);
        } else {
            itemDiv.ondblclick = () => {
                if (data.action) {
                    new Function(data.action)();
                } else if (data.content) {
                    alert(data.content);
                }
            };
        }

        content.appendChild(itemDiv);
    }
}

// --- VS CODE / EDITOR LOGIC ---
const codeFiles = {
    "LoginController.java": `package com.louka.onitama.controller;

import javafx.fxml.FXML;
import javafx.scene.control.TextField;

public class LoginController {
    @FXML
    private TextField usernameField;

    public void onLogin() {
        String user = usernameField.getText();
        if (isValid(user)) {
            System.out.println("User " + user + " logged in.");
            SceneManager.load("GameView.fxml");
        }
    }

    private boolean isValid(String u) {
        return u != null && !u.isEmpty();
    }
}`,
    "server.lua": `AddEventHandler('onResourceStart', function(resourceName)
    if (getCurrentResourceName() ~= resourceName) then
        return
    end
    print('The resource ' .. resourceName .. ' has been started.')
end)

RegisterCommand('hello', function(source, args, rawCommand)
    print("Hello Louka!")
    TriggerClientEvent('chat:addMessage', source, {
        args = { 'System', 'Hello world!' }
    })
end, false)`
};

function initVSCode() {
    const sidebar = document.getElementById('vscode-sidebar');
    if (!sidebar) return;
    sidebar.innerHTML = '';

    Object.keys(codeFiles).forEach(filename => {
        const item = document.createElement('div');
        item.className = 'vscode-file-item';
        item.innerHTML = `<span>‚òï</span> ${filename}`;
        item.onclick = () => loadVSCodeFile(filename);
        sidebar.appendChild(item);
    });

    loadVSCodeFile("LoginController.java");
}

function loadVSCodeFile(filename) {
    const code = codeFiles[filename];
    const codeEl = document.getElementById('vscode-code');
    const tabsEl = document.getElementById('vscode-tabs');

    tabsEl.innerHTML = `<div class="vscode-tab active">${filename}</div>`;

    let formatted = code
        .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
        .replace(/\b(public|class|private|void|String|import|package|return|if|else|function|end|local|then)\b/g, '<span class="token-keyword">$1</span>')
        .replace(/(".*?")/g, '<span class="token-string">$1</span>')
        .replace(/(\/\/.*)/g, '<span class="token-comment">$1</span>')
        .replace(/\b(\d+)\b/g, '<span class="token-number">$1</span>');

    codeEl.innerHTML = formatted;
}

// Hook into window.onload for VS Code init
const originalOnload = window.onload;
window.onload = function () {
    if (originalOnload) originalOnload();
    initVSCode();
};

function updatePreview() {
    const select = document.getElementById('wallpaper-select');
    const value = select.value;
    const preview = document.querySelector('#preview-screen');

    if (!preview) return;

    preview.style.backgroundImage = 'none';
    preview.style.backgroundColor = 'var(--desktop-teal)';

    switch (value) {
        case 'teal':
            preview.style.backgroundColor = '#008080';
            break;
        case 'red':
            preview.style.backgroundColor = '#800000';
            break;
        case 'black':
            preview.style.backgroundColor = '#000000';
            break;
        case 'clouds':
            preview.style.backgroundImage = 'url("https://win98icons.alexmeub.com/images/clouds.jpg")';
            preview.style.backgroundSize = 'cover';
            break;
        case 'bsod':
            preview.style.backgroundColor = '#0000AA';
            break;
        case 'original':
            preview.style.backgroundImage = 'url("assets/images/Fond.jpg")'; // Local path
            preview.style.backgroundSize = 'cover';
            break;
    }
}

function applyWallpaper() {
    const select = document.getElementById('wallpaper-select');
    const value = select.value;

    document.body.style.backgroundImage = 'none'; // reset

    switch (value) {
        case 'teal':
            document.body.style.backgroundColor = '#008080';
            break;
        case 'red':
            document.body.style.backgroundColor = '#800000';
            break;
        case 'black':
            document.body.style.backgroundColor = '#000000';
            break;
        case 'clouds':
            document.body.style.backgroundImage = 'url("https://win98icons.alexmeub.com/images/clouds.jpg")';
            break;
        case 'matrix':
            // Handled by canvas, but maybe set black bg
            document.body.style.backgroundColor = 'black';
            startMatrix(); // Ensure matrix is running
            break;
        case 'original':
            document.body.style.backgroundImage = 'url("assets/images/Fond.jpg")';
            break;
    }
    closeWindow('win-properties');
}


// --- MODEM SIMULATION ---
function simulateModem() {
    // Only run if not disabled by user preference (optional, implementing simple for now)
    // Check if session storage has flag (so it only runs once per tab session)
    if (sessionStorage.getItem('modemRan')) {
        // Just boot
        document.getElementById('boot-msg').innerHTML = (translations[currentLang]?.boot_sequence || "Starting LoukaOS 98...") + " <span class='cursor-blink'>_</span>";
        setTimeout(() => {
            document.getElementById('boot-screen').style.display = 'none';
            playStartupSound();
        }, 1500);
        return;
    }

    sessionStorage.setItem('modemRan', 'true');

    // Hide boot screen for a moment while modem overlay handles things? 
    // Actually, "Boot screen" typically comes AFTER BIOS but BEFORE Desktop.
    // Let's show Modem Overlay ON TOP of Boot Screen.

    const overlay = document.getElementById('modem-overlay');
    const log = document.getElementById('modem-log');
    overlay.style.display = 'flex'; // It's a window flex

    // Play sound
    // Using a short creative commons dialup sound or beep sequence
    // const audio = new Audio('assets/sounds/dialup.mp3'); // We don't have file
    // Let's simulate with text updates, sound is hard without file.
    // I will try to use a decent online sound if possible, or just skip sound if file missing.
    const modemAudio = new Audio('https://www.myinstants.com/media/sounds/dial-up-internet.mp3');
    modemAudio.volume = 0.5;
    modemAudio.play().catch(() => console.log("Auto-play prevented"));

    const steps = [
        { text: "AT Z", delay: 500 },
        { text: "OK", delay: 800 },
        { text: "ATDT 44656489001", delay: 1500 },
        { text: "CONNECT 56000...", delay: 5000 },
        { text: "Verifying Username and Password...", delay: 6000 },
        { text: "Logged on.", delay: 7000 }
    ];

    let stepIndex = 0;

    function nextStep() {
        if (stepIndex >= steps.length) {
            setTimeout(() => {
                overlay.style.display = 'none';
                modemAudio.pause();
                // Resume boot sequence
                document.getElementById('boot-msg').innerHTML = (translations[currentLang]?.boot_sequence || "Starting LoukaOS 98...") + " <span class='cursor-blink'>_</span>";
                setTimeout(() => {
                    document.getElementById('boot-screen').style.display = 'none';
                    playStartupSound();

                    // Trigger Clippy a bit later
                    setTimeout(() => {
                        showClippy(translations[currentLang]?.clippy_intro);
                    }, 4000);
                }, 1500);
            }, 1000);
            return;
        }

        const step = steps[stepIndex];
        setTimeout(() => {
            log.innerHTML += step.text + "<br>";
            log.scrollTop = log.scrollHeight;
            stepIndex++;
            nextStep();
        }, step.delay - (stepIndex > 0 ? steps[stepIndex - 1].delay : 0));
    }

    nextStep();
}

function skipModem() {
    const overlay = document.getElementById('modem-overlay');
    overlay.style.display = 'none';
    // Resume boot immediately
    document.getElementById('boot-screen').style.display = 'none';
    playStartupSound();
}

// Override existing window.onload to include modem
window.onload = function () {
    loadIconPositions();
    initPaint();
    initNotepad();
    setupKeyboardAccessibility();

    // Init VS Code Mock
    if (typeof initVSCode === 'function') initVSCode();

    // Start Modem text instead of direct boot
    simulateModem();
}

// --- CLIPPY INTERACTION ---
function showClippy(text) {
    const clippy = document.getElementById('clippy');
    const bubble = document.getElementById('clippy-text');

    if (!text) text = "Salut ! Je vois que vous cherchez un d√©veloppeur comp√©tent. Besoin d'aide ?";

    // Add interactive buttons if it's the intro
    if (text.includes("Besoin d'aide") || text.includes("Need help")) {
        bubble.innerHTML = `
            ${text}<br><br>
            <button class="btn-retro" style="width:100%; margin-bottom:5px;" onclick="clippyAsk('dispo')">üìÖ Vos disponibilit√©s ?</button>
            <button class="btn-retro" style="width:100%; margin-bottom:5px;" onclick="clippyAsk('stack')">üíª Pourquoi cette stack ?</button>
            <button class="btn-retro" style="width:100%;" onclick="clippyAsk('contact')">üìß Vous contacter ?</button>
        `;
    } else {
        bubble.innerHTML = text;
    }

    clippy.style.display = 'flex';
}

function clippyAsk(topic) {
    const bubble = document.getElementById('clippy-text');
    let answer = "";

    switch (topic) {
        case 'dispo':
            answer = "Je suis disponible pour un stage ou une alternance ! On signe o√π ? ‚úçÔ∏è";
            break;
        case 'stack':
            answer = "J'adore Java pour le backend robuste, et React/JS pour le front. Mais je m'adapte √† tout ! üöÄ";
            break;
        case 'contact':
            answer = "Envoyez-moi un mail √† louka.riquoir@gmail.com ou ajoutez-moi sur LinkedIn via Internet Explorer ! üåê";
            break;
    }

    bubble.innerHTML = `${answer}<br><br><span style="font-size:0.7rem; color:blue; cursor:pointer;" onclick="showClippy()">üîô Retour</span>`;
}
